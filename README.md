# Рекомендация банковских продуктов

Финальный проект курса ML Engineering (Yandex Practicum).

**Цель:** предсказать, какие банковские продукты (кредиты, депозиты, карты, инвестиционные инструменты) клиент приобретёт в следующем месяце, на основе данных о его поведении за 1.5 года.

**Результат:** ансамбль из 22 LightGBM-классификаторов (Binary Relevance), обёрнутый в FastAPI-сервис с Prometheus-мониторингом и Docker-контейнеризацией. MAP@7 на тесте — **0.0225** (baseline 0.0193, +16.5%).

**Технологии:** Python, LightGBM, scikit-learn, Optuna, MLflow, FastAPI, Docker, Prometheus.

---

## Структура проекта

```
final_project_bank/
├── README.md                           # Документация (этот файл)
├── requirements.txt                    # Зависимости проекта (все, pinned)
├── .gitignore                          # Игнорируемые файлы
│
├── notebooks/
│   ├── eda.ipynb                       # EDA — исследовательский анализ данных
│   └── modeling.ipynb                  # Эксперименты, пайплайн, обучение модели
│
├── models/
│   └── model.bin                       # Финальная модель (22 классификатора, 18 МБ)
│
├── scripts/
│   └── start_mlflow.sh                 # Запуск MLflow Tracking Server
│
├── service/                            # Веб-сервис (API)
│   ├── bank_service.py                 # Точка входа (uvicorn runner)
│   ├── app/
│   │   ├── main.py                     # FastAPI-приложение, эндпоинты, middleware
│   │   ├── api/
│   │   │   └── routes.py               # API-роуты
│   │   ├── core/
│   │   │   ├── config.py               # Конфигурация (pydantic-валидация)
│   │   │   ├── store.py                # Загрузка и валидация модели
│   │   │   ├── predictor.py            # Препроцессинг и инференс
│   │   │   └── metrics.py              # Prometheus-метрики
│   │   └── models/
│   │       └── schemas.py              # Pydantic-схемы запросов/ответов
│   ├── tests/
│   │   └── test_service.py             # 7 тестовых сценариев
│   ├── requirements.txt                # Зависимости сервиса (pinned)
│   └── Dockerfile                      # Docker-образ
│
├── monitoring/
│   └── MONITORING.md                   # Описание метрик, алертов, стратегия дообучения
│
└── train_ver2.csv                      # Датасет (~2.1 ГБ, не в репозитории)
```

---

## Установка и запуск

### 1. Клонирование и окружение

```bash
git clone <repository_url>
cd final_project_bank

python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. Загрузка данных

Файл `train_ver2.csv` (~2.1 ГБ, ~13.6 млн строк) не входит в репозиторий. Положите его в корень проекта.

### 3. Запуск MLflow

```bash
bash scripts/start_mlflow.sh              # порт 5000 по умолчанию
bash scripts/start_mlflow.sh --port 5050  # альтернативный порт
```

UI: `http://127.0.0.1:5000`. Остановка: `kill $(cat .mlflow.pid)`.

### 4. Запуск ноутбуков

```bash
jupyter notebook notebooks/eda.ipynb
jupyter notebook notebooks/modeling.ipynb
```

### 5. Запуск сервиса (локально)

```bash
cd service
MODEL_PATH=../models/model.bin python3 bank_service.py
```

### 6. Запуск сервиса (Docker)

```bash
# Build context — корень проекта
docker build -f service/Dockerfile -t bank-recommender .
docker run -p 8000:8000 bank-recommender
```

### 7. Запуск тестов

```bash
cd service
MODEL_PATH=../models/model.bin python3 bank_service.py &   # в фоне
python3 -m tests.test_service                               # в другом терминале
```

---

## Руководство по проекту

### 1. Трансляция бизнес-задачи в техническую

#### Бизнес-задача

Определить, какие банковские продукты предложить конкретному клиенту, чтобы повысить перекрёстные продажи и снизить отток. Рекомендации формируются ежемесячно: для каждого клиента выбирается до 7 наиболее вероятных **новых** продуктов.

#### Техническая задача

**Тип:** multi-label классификация (Binary Relevance).

Для каждого клиента — предсказать вероятность подключения каждого из 22 банковских продуктов в следующем месяце. Целевая переменная — переход продукта из состояния 0 (нет) в 1 (есть) между двумя последовательными месяцами.

**Подход — Binary Relevance:** для каждого целевого продукта обучается отдельный бинарный классификатор (LightGBM). Это позволяет учесть разный масштаб дисбаланса для каждого продукта и настроить гиперпараметры индивидуально.

**Исключённые продукты:** `ind_ahor_fin_ult1` (2 подключения за 17 месяцев) и `ind_aval_fin_ult1` (4 подключения) — недостаточно примеров для обучения. Итого моделируется 22 из 24 продуктов.

#### Разбиение данных

Данные содержат ежемесячные срезы — разбиение строго **по времени** (не случайное):

| Набор | Месяцы | Строк | Назначение |
|-------|--------|-------|------------|
| Train | 2015-02 — 2016-03 | 10 819 720 | Обучение (переходы 0→1 за 14 месяцев) |
| Validation | 2016-04 | 923 501 | Подбор гиперпараметров (Optuna) |
| Test | 2016-05 | 926 740 | Финальная оценка качества |

Первый месяц (2015-01) используется только как «предыдущий» для вычисления переходов.

#### ML-метрики

| Метрика | Описание | Зачем нужна |
|---------|----------|-------------|
| **MAP@7** (основная) | Mean Average Precision при K=7 рекомендаций | Оценивает качество ранжирования: штрафует за неправильный порядок рекомендаций. K=7 — разумное число предложений клиенту. |
| **F1 macro** | Среднее F1 по всем продуктам | Сбалансированное качество по всем продуктам, не позволяет игнорировать редкие. |
| **AUC-ROC per product** | ROC AUC для каждого продукта | Разделяющая способность каждой модели. Выявляет продукты, по которым модель работает хуже. |

#### Бизнес-метрики

| Метрика | Описание |
|---------|----------|
| **Конверсия рекомендаций** | Доля рекомендованных продуктов, которые клиент подключил |
| **Покрытие каталога** | Доля продуктов, рекомендуемых хотя бы одному клиенту |
| **Среднее число рекомендаций** | Контроль «жадности» модели |

#### Baseline

Каждому клиенту рекомендуются 7 продуктов с наибольшей частотой переходов 0→1 в обучающей выборке (без учёта индивидуальных признаков).

### 2. Разворачивание инфраструктуры обучения модели

**MLflow Tracking Server** с SQLite-бэкендом и локальным хранилищем артефактов.

```bash
bash scripts/start_mlflow.sh
```

Скрипт:
- Устанавливает `mlflow` при необходимости
- Создаёт SQLite-базу `mlflow.db` и директорию `mlartifacts/`
- Запускает сервер в фоне, сохраняет PID в `.mlflow.pid`
- Проверяет готовность через health-check

Подключение из ноутбуков:

```python
import mlflow
mlflow.set_tracking_uri("http://127.0.0.1:5000")
```

Залогированные эксперименты: `baseline`, `lightgbm_baseline`, `lightgbm_optuna_tuning`, `final_evaluation`.

### 3. Проведение EDA

Ноутбук: `notebooks/eda.ipynb`

Ключевые результаты:

- **Общая статистика:** 13.6 млн строк, 48 колонок, 956K уникальных клиентов, 17 месяцев (янв 2015 — май 2016).
- **Пропуски:** `renta` (доход) — 20.5% пропусков; `conyuemp`, `ult_fec_cli_1t`, `tipodom` удалены (100%/99.8% NaN / константа). 27 734 полностью битых строк удалены.
- **Распределения:** медианный возраст 39 лет, медианный доход 101K, сильный правый скос дохода. 99.2% клиентов — резиденты Испании.
- **Продукты:** сильный дисбаланс — текущие счета есть у 65.6% клиентов, 8 продуктов < 1%. Два продукта с близкой к нулю распространённостью исключены из моделирования.
- **Переходы 0→1:** 562K подключений за весь период, только 3.5% записей содержат хотя бы одно подключение. Лидеры: дебетовый аккаунт (27%), пенсионный аккаунт (15%), зарплатный аккаунт (13%).
- **Корреляции:** `nomina` / `nom_pens` — корреляция 0.95, P(пенсионный | зарплатный) = 1.0.
- **Временная динамика:** скачок клиентской базы в июле 2015 (+200К, +31.7%).

### 4. Генерация признаков и обучение модели

Ноутбук: `notebooks/modeling.ipynb`

#### Признаки (44 итоговых)

| Группа | Признаки | Количество |
|--------|----------|------------|
| Числовые | `age` (clip 18–100), `log_renta` (log1p дохода), `antiguedad`, `ind_nuevo`, `indrel`, `ind_actividad_cliente`, `cod_prov` | 7 |
| Категориальные (LabelEncoder) | `sexo`, `ind_empleado`, `tiprel_1mes`, `indresi`, `indext`, `indfall`, `segmento`, `indrel_1mes` | 8 |
| Категориальные (спец.) | `canal_entrada` (top-20 + OTHER), `pais_residencia` (бинарный: ES / не-ES), `nomprov` (top-20 + OTHER) | 3 |
| Лаговые | `prev_{product}` — наличие каждого из 22 продуктов в предыдущем месяце | 22 |
| Агрегатные | `n_products` (сумма текущих продуктов), `product_changes` (число изменений) | 2 |
| Временные | `month` (месяц), `months_since_start` (от начала данных) | 2 |

Обработка пропусков:
- `renta` → заполнение медианой по сегменту, затем глобальной медианой, далее log1p
- `antiguedad` → замена -999999 на NaN, заполнение медианой
- `age` → очистка строковых значений, clip [18, 100]
- `ind_nuevo`, `indrel`, `ind_actividad_cliente`, `cod_prov` → заполнение модой

#### Эксперименты

Все эксперименты залогированы в MLflow. Ход экспериментов:

**1. Baseline (по популярности):**
Каждому клиенту — 7 самых частых продуктов из обучающей выборки. Нижняя граница качества.

**2. LightGBM (дефолтные параметры):**
22 бинарных классификатора с `scale_pos_weight` для компенсации дисбаланса. MAP@7 ниже baseline — модель не ранжирует лучше простого правила.

**3. LightGBM + Optuna (50 trials на 8 топовых продуктов):**
Оптимизация по AUC-ROC на validation. Индивидуальная настройка: `n_estimators`, `learning_rate`, `num_leaves`, `max_depth`, `min_child_samples`, `subsample`, `colsample_bytree`, `reg_alpha`, `reg_lambda`. Для 14 менее частых продуктов — дефолтные параметры.

#### Результаты на тесте

| Модель | MAP@7 | F1 macro | Mean AUC-ROC |
|--------|-------|----------|--------------|
| Baseline (popularity) | 0.0193 | 0.0042 | — |
| LightGBM base | 0.0123 | 0.1879 | 0.3813 |
| **LightGBM tuned** | **0.0225** | **0.1902** | **0.4174** |

LightGBM tuned превосходит baseline по MAP@7 на **16.5%** и по F1 macro в **45 раз**.

#### AUC-ROC по продуктам (тест, LightGBM tuned)

| Продукт | AUC-ROC |
|---------|---------|
| Зарплатный аккаунт | 0.9998 |
| Пенсионный аккаунт | 0.9998 |
| Зарплатный проект | 0.9995 |
| Текущие счета | 0.9993 |
| Дебетовый аккаунт | 0.9980 |
| Цифровой счёт | 0.9950 |
| Долгосрочный депозит | 0.9950 |
| Кредитная карта | 0.9945 |

Топ-8 продуктов (покрывающих 95% переходов) демонстрируют AUC-ROC > 0.99. Оптимизация Optuna дала наибольший прирост для цифрового счёта (с 0.33 до 0.99) и долгосрочного депозита (с 0.86 до 0.99).

#### Финальная модель

- **Артефакт:** `models/model.bin` (18 МБ, формат joblib)
- **Содержимое:** 22 LightGBM-классификатора, 10 LabelEncoder, списки top-20 каналов и провинций, маппинг продуктов
- **Воспроизводимость:** `random_state=42` во всех моделях и Optuna

### 5. Разворачивание инфраструктуры применения модели

#### Архитектура сервиса

FastAPI-приложение с модульной структурой (`app/core/`, `app/models/`, `app/api/`):

- `ModelStore` — загрузка и валидация артефакта модели
- `BankPredictor` — препроцессинг (44 признака) + инференс (22 модели)
- `ServiceConfig` — pydantic-валидация конфигурации
- Prometheus middleware — автоматический сбор HTTP-метрик

#### API-эндпоинты

| Метод | Путь | Описание |
|-------|------|----------|
| GET | `/health` | Состояние сервиса: статус, загружена ли модель |
| GET | `/model/info` | Метаданные модели: признаки, продукты, названия |
| POST | `/predict` | Рекомендации продуктов для клиента |
| GET | `/metrics` | Prometheus-метрики |

Swagger UI доступен по адресу `http://localhost:8000/docs`.

#### POST /predict — формат запроса

```json
{
  "age": 35,
  "renta": 120000,
  "antiguedad": 60,
  "sexo": "H",
  "segmento": "02 - PARTICULARES",
  "canal_entrada": "KHE",
  "pais_residencia": "ES",
  "nomprov": "MADRID",
  "ind_empleado": "N",
  "tiprel_1mes": "A",
  "indresi": "S",
  "indext": "N",
  "indfall": "N",
  "indrel_1mes": "1",
  "ind_nuevo": 0,
  "indrel": 1,
  "ind_actividad_cliente": 1,
  "cod_prov": 28,
  "prev_products": {
    "ind_cco_fin_ult1": 1,
    "ind_recibo_ult1": 1
  },
  "product_changes": 0,
  "fecha_dato": "2016-05-28",
  "top_k": 7
}
```

Обязательные поля: `age`, `prev_products`. Все остальные опциональны (заполняются медианами/модами из обучающей выборки).

#### POST /predict — формат ответа

```json
{
  "recommendations": [
    {"product_col": "ind_reca_fin_ult1", "product_name": "Налоговый счёт", "probability": 0.000680},
    {"product_col": "ind_ctma_fin_ult1", "product_name": "Особый счёт 3", "probability": 0.000386},
    {"product_col": "ind_valo_fin_ult1", "product_name": "Ценные бумаги", "probability": 0.000379}
  ],
  "n_current_products": 2
}
```

Рекомендации отсортированы по убыванию вероятности. Продукты, которые клиент уже имеет, исключаются.

#### Docker

```bash
# Сборка (из корня проекта)
docker build -f service/Dockerfile -t bank-recommender .

# Запуск
docker run -p 8000:8000 bank-recommender

# Проверка
curl http://localhost:8000/health
```

Образ: `python:3.12-slim` + `libgomp1` (для LightGBM). Размер: ~450 МБ.

#### Тестирование

7 автоматических тестов (`service/tests/test_service.py`):

| Тест | Что проверяет |
|------|---------------|
| 0 | Health check — сервис работает, модель загружена |
| 1 | Model info — 22 модели, 44 признака, 22 продукта |
| 2 | Predict (минимум) — только `age` + `prev_products` |
| 3 | Predict (полный) — все признаки, исключение имеющихся продуктов |
| 4 | Параметр `top_k` — корректное ограничение количества рекомендаций |
| 5 | Исключение продуктов — 8 имеющихся продуктов не попадают в рекомендации |
| 6 | Валидация — 422 при невалидных данных (age < 0, нет обязательных полей) |
| 7 | Неизвестные категории — graceful degradation (safe_label_encode) |

### 6. Мониторинг

Подробное описание: `monitoring/MONITORING.md`.

Сервис экспортирует Prometheus-метрики через `GET /metrics`. Метрики собираются из кода через `prometheus_client`.

#### Технические метрики

| Метрика | Тип | Описание |
|---------|-----|----------|
| `http_requests_total` | Counter | Количество HTTP-запросов (method, endpoint, status_code) |
| `http_request_duration_seconds` | Histogram | Latency HTTP-запросов |
| `prediction_duration_seconds` | Histogram | Latency инференса (без HTTP overhead) |
| `prediction_errors_total` | Counter | Ошибки инференса |
| `model_load_time_seconds` | Gauge | Время загрузки модели при старте |

#### ML-метрики

| Метрика | Тип | Описание |
|---------|-----|----------|
| `prediction_probability` | Histogram | Распределение P(1) по всем продуктам |
| `top1_probability` | Histogram | Вероятность топ-1 рекомендации |
| `recommendations_count` | Histogram | Количество рекомендаций в ответе |

#### Бизнес-метрики

| Метрика | Тип | Описание |
|---------|-----|----------|
| `recommended_product_total` | Counter | Частота рекомендаций по продуктам |
| `client_products_count` | Histogram | Размер портфеля клиентов |
| `client_age` | Histogram | Возраст клиентов в запросах |

#### Ключевые алерты

| Условие | Severity |
|---------|----------|
| p99 latency `/predict` > 1с | warning |
| Error rate > 0.1/s | critical |
| median(top1_probability) изменился > 30% за неделю | warning (дрифт) |
| Продукт не рекомендуется > 7 дней | warning |

#### Стратегия дообучения

- **Плановое:** 1 раз в месяц при поступлении нового среза данных
- **Экстренное:** при срабатывании алертов дрифта (сдвиг распределения вероятностей, падение MAP@7 > 20%)

---

## Описание данных

Файл `train_ver2.csv` — данные о поведении клиентов банка с 28 января 2015 по июнь 2016. Ежемесячные записи: одна строка = один клиент в одном месяце.

### Признаки клиента (колонки 1–24)

| Колонка | Описание |
|---------|----------|
| `fecha_dato` | Дата записи (ежемесячные срезы) |
| `ncodpers` | ID клиента |
| `ind_empleado` | Статус занятости (A/B/F/N/S) |
| `pais_residencia` | Страна резидентства |
| `sexo` | Пол (H — мужской, V — женский) |
| `age` | Возраст |
| `fecha_alta` | Дата первого контракта с банком |
| `ind_nuevo` | Новый клиент, зарегистрирован < 6 мес. (1/0) |
| `antiguedad` | Стаж клиента в банке (мес.) |
| `indrel` | Тип: 1 — первичный, 99 — первичный в течение месяца |
| `ult_fec_cli_1t` | Последняя дата премиального статуса |
| `indrel_1mes` | Тип в начале месяца: 1=премиальный, 2=собственник, P=потенциальный |
| `tiprel_1mes` | Отношения: A=активный, I=неактивный, P=бывший, R=потенциальный |
| `indresi` | Резидент страны банка (S/N) |
| `indext` | Страна рождения отличается от страны банка (S/N) |
| `conyuemp` | Супруг(а) сотрудника банка (S/N) |
| `canal_entrada` | Канал привлечения клиента |
| `indfall` | Индекс актуальности счёта (N/S) |
| `tipodom` | Тип адреса (1 — основной) |
| `cod_prov` | Код провинции |
| `nomprov` | Название провинции |
| `ind_actividad_cliente` | Активность (1 — активный, 0 — нет) |
| `renta` | Доход домохозяйства |
| `segmento` | Сегмент: 01=VIP, 02=Обычные, 03=Выпускники |

### Банковские продукты (колонки 25–48, целевые переменные)

| Колонка | Продукт |
|---------|---------|
| `ind_ahor_fin_ult1` | Сберегательный счёт |
| `ind_aval_fin_ult1` | Банковская гарантия |
| `ind_cco_fin_ult1` | Текущие счета |
| `ind_cder_fin_ult1` | Деривативный счёт |
| `ind_cno_fin_ult1` | Зарплатный проект |
| `ind_ctju_fin_ult1` | Детский счёт |
| `ind_ctma_fin_ult1` | Особый счёт 3 |
| `ind_ctop_fin_ult1` | Особый счёт |
| `ind_ctpp_fin_ult1` | Особый счёт 2 |
| `ind_deco_fin_ult1` | Краткосрочный депозит |
| `ind_deme_fin_ult1` | Среднесрочный депозит |
| `ind_dela_fin_ult1` | Долгосрочный депозит |
| `ind_ecue_fin_ult1` | Цифровой счёт |
| `ind_fond_fin_ult1` | Денежные средства |
| `ind_hip_fin_ult1` | Ипотека |
| `ind_plan_fin_ult1` | Пенсионный план |
| `ind_pres_fin_ult1` | Кредит |
| `ind_reca_fin_ult1` | Налоговый счёт |
| `ind_tjcr_fin_ult1` | Кредитная карта |
| `ind_valo_fin_ult1` | Ценные бумаги |
| `ind_viv_fin_ult1` | Домашний счёт |
| `ind_nomina_ult1` | Зарплатный аккаунт |
| `ind_nom_pens_ult1` | Пенсионный аккаунт |
| `ind_recibo_ult1` | Дебетовый аккаунт |

---

## Известные ограничения

- **Редкие продукты:** деривативный счёт, ипотека, домашний счёт имеют AUC-ROC < 0.05 на тесте — слишком мало примеров переходов для обучения.
- **Статическая модель:** нет онлайн-обучения или инкрементального обновления. Модель перенастраивается вручную при накоплении нового месяца данных.
- **Неизвестные категории:** новые значения `canal_entrada` или `nomprov`, не встречавшиеся при обучении, группируются в категорию OTHER через safe_label_encode.
- **Дисбаланс классов:** положительные примеры составляют от 0.001% до 1.2% в зависимости от продукта. Компенсируется через `scale_pos_weight` в LightGBM.
- **Временной горизонт:** модель обучена на данных 2015–2016 года. При использовании на новых данных может потребоваться переобучение с учётом изменения поведения клиентов.

---

## Воспроизводимость

- **Python 3.10+** (в Docker — 3.12)
- **`random_state=42`** во всех стохастических операциях: LightGBM, Optuna (`TPESampler(seed=42)`), `np.random.seed(42)`
- **Все зависимости зафиксированы** с точными версиями (`==`) в двух файлах:
  - `requirements.txt` — полный проект (ноутбуки + сервис + визуализация + MLflow)
  - `service/requirements.txt` — только зависимости сервиса (для Docker)
- **Все эксперименты залогированы в MLflow** с параметрами, метриками и артефактами
- **Временное разбиение** train/val/test по `fecha_dato` гарантирует отсутствие утечки данных из будущего
- **Модель сериализована** в `models/model.bin` (joblib) — содержит модели, энкодеры и метаданные для полного воспроизведения инференса
